<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BizFitクラブ</title>
  <style>
    /* ※ 既存デザインを壊したくない場合は、ここをあなたのCSSに合わせて最小限にしてください */
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;margin:0;background:#f6f6f6;}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#fff;border-bottom:1px solid #eee;}
    .brand{font-weight:700}
    .container{max-width:480px;margin:0 auto;padding:16px;}
    .card{background:#fff;border-radius:16px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.06);margin-bottom:12px;}
    .btn{display:inline-flex;align-items:center;justify-content:center;border:none;border-radius:12px;padding:12px 14px;font-weight:700;cursor:pointer}
    .btn.primary{background:#b67a12;color:#fff;width:100%;}
    .btn.ghost{background:#fff;border:1px solid #ddd;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:#666;font-size:12px}
    input,select{width:100%;box-sizing:border-box;border:1px solid #ddd;border-radius:12px;padding:12px 12px;font-size:16px;background:#fff;}
    label{display:block;font-size:12px;color:#555;margin:10px 0 6px;}
    .title{font-size:22px;font-weight:800;text-align:center;margin:6px 0 14px;}
    .hidden{display:none!important}
    .event-title{font-size:16px;font-weight:800;margin:0 0 6px;}
    .event-meta{font-size:13px;color:#444;margin:0 0 10px;line-height:1.5}
    .event-detail{font-size:14px;color:#333;white-space:pre-wrap;margin:10px 0;}
    .actions{display:flex;gap:10px;margin-top:10px;}
    .actions .btn{flex:1}
    .pill{display:inline-block;background:#f2f2f2;border-radius:999px;padding:4px 10px;font-size:12px;margin-left:6px}
    .danger{color:#c0392b;font-weight:700}
    .ok{color:#1e8449;font-weight:700}
  </style>
</head>
<body>
<header>
  <div class="brand">BizFitクラブ</div>
  <div class="row">
    <button class="btn ghost" id="toRegisterBtn">新規登録</button>
    <button class="btn ghost" id="toEventsBtn">イベント</button>
  </div>
</header>

<div class="container">

  <!-- 画面：イベント一覧 -->
  <section id="viewEvents" class="card">
    <div class="title">イベント一覧</div>
    <div id="eventsLoading" class="muted">読み込み中…</div>
    <div id="eventsList"></div>
  </section>

  <!-- 画面：新規会員登録 -->
  <section id="viewRegister" class="card hidden">
    <div class="title" id="registerTitle">新規会員登録</div>

    <!-- ★ここが要望：氏名 / ふりがな をメールと同じサイズで縦2段（メールの上） -->
    <label for="nameInput">氏名</label>
    <input id="nameInput" type="text" autocomplete="name" />

    <label for="kanaInput">ふりがな</label>
    <input id="kanaInput" type="text" />

    <label for="emailInput">メールアドレス</label>
    <input id="emailInput" type="email" autocomplete="email" inputmode="email" />

    <div class="row">
      <div style="flex:1">
        <label for="ageSelect">年代</label>
        <select id="ageSelect">
          <option value="">選択</option>
          <option>10代</option><option>20代</option><option>30代</option><option>40代</option><option>50代</option><option>60代</option><option>70代以上</option>
        </select>
      </div>
      <div style="flex:1">
        <label for="genderSelect">性別</label>
        <select id="genderSelect">
          <option value="">選択</option>
          <option>男性</option><option>女性</option><option>その他</option><option>回答しない</option>
        </select>
      </div>
    </div>

    <label for="jobSelect">業種</label>
    <select id="jobSelect">
      <option value="">選択</option>
      <option>会社員</option><option>自営業</option><option>公務員</option><option>学生</option><option>主婦/主夫</option><option>その他</option>
    </select>

    <label for="purposeSelect">目的</label>
    <select id="purposeSelect">
      <option value="">選択</option>
      <option>運動不足解消</option><option>健康維持</option><option>交流</option><option>体力向上</option><option>その他</option>
    </select>

    <label for="referrerInput">紹介者名（任意）</label>
    <input id="referrerInput" type="text" />

    <label for="lineUserIdInput">LINE_UserID（任意）</label>
    <input id="lineUserIdInput" type="text" />

    <div style="height:12px"></div>

    <button class="btn primary" id="registerBtn">登録を完了してはじめる</button>
    <div id="registerMsg" class="muted" style="margin-top:10px;"></div>
  </section>

</div>

<script>
  /** ★あなたのデプロイURLを埋め込み済み */
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbyG2Z4cs8AUnzbLI_TH8sSdIVPfe5ziITlZU_R8szJjHOlB4wK3UrE2SJuJWm8rNOP3sA/exec";

  // 通信：CORS対策で x-www-form-urlencoded の POST（プリフライト回避）
  async function api(action, params = {}) {
    const body = new URLSearchParams({ action, ...params });

    const res = await fetch(GAS_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });

    // ここで通信エラーを拾う（iPhoneで「通信エラー」になる原因の切り分けに重要）
    if (!res.ok) throw new Error(`HTTP ${res.status}`);

    const json = await res.json();
    if (!json.success) throw new Error(json.message || "API error");
    return json.data;
  }

  function show(id) {
    document.getElementById("viewEvents").classList.add("hidden");
    document.getElementById("viewRegister").classList.add("hidden");
    document.getElementById(id).classList.remove("hidden");
  }

  document.getElementById("toRegisterBtn").addEventListener("click", () => show("viewRegister"));
  document.getElementById("toEventsBtn").addEventListener("click", () => { show("viewEvents"); loadEvents(); });

  // 初期疎通確認（「初期読み込みに失敗しました」を潰す）
  (async () => {
    try {
      await api("ping");
      // OKならイベント一覧を読み込み
      await loadEvents();
    } catch (e) {
      document.getElementById("eventsLoading").innerHTML =
        `<span class="danger">初期読み込みに失敗しました。</span><br>GAS_API_URL とデプロイ設定を確認してください。<br><span class="muted">${escapeHtml(String(e))}</span>`;
    }
  })();

  async function loadEvents() {
    const loading = document.getElementById("eventsLoading");
    const listEl = document.getElementById("eventsList");
    loading.textContent = "読み込み中…";
    listEl.innerHTML = "";

    try {
      const events = await api("listEvents");
      loading.textContent = "";

      if (!events.length) {
        listEl.innerHTML = `<div class="muted">イベントがありません</div>`;
        return;
      }

      events.forEach(ev => {
        const disabled = (ev.remain <= 0);
        const mapBtn = ev.mapUrl ? `<button class="btn ghost js-map" data-url="${encodeURIComponent(ev.mapUrl)}">MAP</button>` : "";
        const detailBtn = `<button class="btn ghost js-detail" data-id="${escapeAttr(ev.eventId)}">詳細</button>`;
        const applyBtn = `<button class="btn ${disabled ? "ghost" : "primary"} js-apply" data-id="${escapeAttr(ev.eventId)}" ${disabled ? "disabled" : ""}>申し込み</button>`;

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="event-title">${escapeHtml(ev.name)} <span class="pill">${escapeHtml(ev.status || "—")}</span></div>
          <div class="event-meta">
            ${escapeHtml(ev.date)} ${escapeHtml(ev.time)}<br>
            ${escapeHtml(ev.facility || "")} ${escapeHtml(ev.room || "")}<br>
            残り：<span class="${disabled ? "danger" : "ok"}">${ev.remain}</span> / ${ev.capacity}
          </div>
          <div class="event-detail hidden" id="detail-${escapeAttr(ev.eventId)}"></div>
          <div class="actions">
            ${detailBtn}
            ${mapBtn}
            ${applyBtn}
          </div>
        `;
        listEl.appendChild(card);
      });

      // ★「反応しない」を潰す：描画後に必ずイベントリスナーを付け直す
      listEl.querySelectorAll(".js-map").forEach(btn => {
        btn.addEventListener("click", () => {
          const url = decodeURIComponent(btn.dataset.url || "");
          if (url) window.open(url, "_blank");
        });
      });

      listEl.querySelectorAll(".js-detail").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const detailEl = document.getElementById(`detail-${id}`);
          if (!detailEl) return;

          // トグル表示
          const isHidden = detailEl.classList.contains("hidden");
          if (!isHidden) {
            detailEl.classList.add("hidden");
            return;
          }

          // 開く時に詳細を取得（既に入っていれば再取得しない）
          if (!detailEl.dataset.loaded) {
            const ev = await api("getEvent", { eventId: id });
            detailEl.textContent = ev.detail || "（詳細なし）";
            detailEl.dataset.loaded = "1";
          }
          detailEl.classList.remove("hidden");
        });
      });

      listEl.querySelectorAll(".js-apply").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.dataset.id;
          const memberId = localStorage.getItem("memberId") || "";
          const name = localStorage.getItem("name") || "";

          if (!memberId || !name) {
            alert("先に新規登録を行ってください（会員IDを発行します）");
            show("viewRegister");
            return;
          }

          const companions = prompt("同伴人数（0以上の数字）", "0");
          const n = Math.max(0, parseInt(companions || "0", 10) || 0);

          try {
            await api("applyEvent", { eventId: id, memberId, name, companions: String(n) });
            alert("申し込みが完了しました");
            await loadEvents();
          } catch (e) {
            alert("申し込みに失敗しました：" + e.message);
          }
        });
      });

    } catch (e) {
      loading.innerHTML = `<span class="danger">イベントの取得に失敗しました</span><br><span class="muted">${escapeHtml(String(e))}</span>`;
    }
  }

  document.getElementById("registerBtn").addEventListener("click", async () => {
    const msg = document.getElementById("registerMsg");
    msg.textContent = "";

    const name = document.getElementById("nameInput").value.trim();
    const kana = document.getElementById("kanaInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    const age = document.getElementById("ageSelect").value.trim();
    const gender = document.getElementById("genderSelect").value.trim();
    const job = document.getElementById("jobSelect").value.trim();
    const purpose = document.getElementById("purposeSelect").value.trim();
    const referrer = document.getElementById("referrerInput").value.trim();
    const lineUserId = document.getElementById("lineUserIdInput").value.trim();

    if (!name || !kana || !email) {
      msg.innerHTML = `<span class="danger">氏名・ふりがな・メールアドレスは必須です。</span>`;
      return;
    }

    try {
      msg.textContent = "登録中…";
      const r = await api("registerMember", { name, kana, email, age, gender, job, purpose, referrer, lineUserId });

      // 端末に保存（イベント申込で使う）
      localStorage.setItem("memberId", r.memberId);
      localStorage.setItem("password", r.password);
      localStorage.setItem("name", name);

      msg.innerHTML = `<span class="ok">登録完了！</span><br>会員ID：<b>${escapeHtml(r.memberId)}</b><br>パスワード：<b>${escapeHtml(r.password)}</b>`;
      alert(`登録完了\n会員ID：${r.memberId}\nパスワード：${r.password}\n（端末に保存しました）`);

      show("viewEvents");
      await loadEvents();
    } catch (e) {
      msg.innerHTML = `<span class="danger">登録に失敗しました（通信エラー）</span><br><span class="muted">${escapeHtml(e.message)}</span>`;
    }
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }
</script>
</body>
</html>
